### 授权微博访问 [已完成]

1. 在 Google 表格中，点击 **🤖 回复系统 → 🌐 微博集成 → 🔐 授权微博访问**
2. 弹出对话框显示授权链接
3. 点击链接（在新标签页打开）
4. 使用拥有该应用的微博账号登录
5. 点击 **授权** 以授予权限
6. 您将看到"成功！您可以关闭此标签页"
7. 关闭标签页并关闭对话框

### 测试连接

1. 点击 **🤖 回复系统 → ⚙️ 设置**
2. 点击 **🔌 测试连接**
3. 您应该看到：
   - ✅ DeepSeek API：已连接
   - ✅ 微博 API：已授权

### **测试完整工作流程**

这将演示完整的 AI 回复生成和发布周期。

#### 步骤 1：拉取最新帖子（更新"触发帖子"工作表）
```
🤖 回复系统 → 🔄 为所有用户拉取最新帖子
```
**功能说明**：
- 扫描帖子工作表中的所有用户
- 查找每个用户的最新帖子（按时间戳）
- 将这些"最新帖子"复制到触发帖子工作表
- 这些将成为 AI 将要回复的帖子
- 显示摘要："✅ 已为 226 位用户更新其最新帖子！"

#### 步骤 2：生成 AI 回复
1. **在 Users 工作表中选择用户**（仅选择非对照组用户）
2. **点击** `🤖 回复系统 → 📝 为选中的用户生成回复`

**功能说明**：
- 对于每个选中的用户：
  - 从触发帖子工作表获取其触发帖子
  - 获取其发帖历史（仅 Group2 和 Group4）
  - 从 Prompts 工作表获取相应的提示模板
  - 替换占位符：`{user_name}`、`{post_content}`、`{user_history}`
  - 使用构建的提示调用 DeepSeek API
  - 将回复保存到回复队列，包含所有上下文

1. **检查回复队列** 中已生成的回复
   - 每行显示：时间戳、用户信息、触发帖子、AI 回复
   - `approved` 列默认为 "NO"
   - `history_context` 显示提供了哪些历史帖子（如果有）
   - `prompt_sent` 显示发送到 DeepSeek 的确切提示

#### 步骤 3：发送到微博
1. **在回复队列中**，将 `approved` 值更改为 "YES" 以发送您想要的回复
   - 您还可以编辑 `final_response` 以在发送前自定义文本

2. **点击** `🤖 回复系统 → 🌐 微博集成 → 📤 发送已批准的回复`

**功能说明**：
- 扫描回复队列中满足以下条件的行：
  - `approved` = "YES"
  - `sent_date` 为空
  - `weibo_send_status` 不为 "success"
- 对于每个已批准的回复：
  - 将文本截断为 140 个字符（微博限制）
  - 调用微博 API 端点 `/2/comments/create.json`
  - 在原微博帖子上发布评论
  - 使用以下信息更新回复队列：
    - `weibo_comment_id`：已发布评论的 ID
    - `weibo_send_status`："success" 或 "failed"
    - `sent_date`：当前时间戳
    - `weibo_error_message`：如果失败，显示错误详情

1. **在回复队列中检查结果**：
   - 查找 `weibo_comment_id` - 这确认发布成功
   - 失败的发送在 `weibo_error_message` 列中显示错误
   - 常见错误：帖子已删除、评论太长、速率限制

### 理解数据流

```
微博 → 帖子工作表 → 触发帖子工作表 → AI 生成 → 回复队列 → 微博
```
1. **同步**：微博的真实帖子 → 帖子工作表
2. **选择**：每个用户的最新帖子 → 触发帖子工作表
3. **生成**：触发帖子 + 提示 → 回复队列中的 AI 回复
4. **批准**：人工审核和批准
5. **发送**：已批准的回复 → 作为微博评论发布

## 重要说明：

- **速率限制**：150 次请求/小时 - 请相应计划
- **评论长度**：微博限制为 140 个字符
- **同步频率**：不要过度同步；通常每天一次就足够了
- **错误处理**：检查 `weibo_error_message` 列以查看失败
- **安全性**：切勿分享应用密钥或 API 密钥
